"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,t=require("eventemitter3"),n=require("babel-plugin-transform-async-to-promises/helpers"),r=(e=require("isomorphic-ws"))&&"object"==typeof e&&"default"in e?e.default:e,s=function(){function e(){}return e.matches=function(e,t){if(null==e||0===Object.keys(e).length)return!0;if(null==t)return!1;for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)&&!this.valueMatches(e[n]||"",t[n]))return!1;return!0},e.valueMatches=function(e,t){return void 0!==t&&(""===(e||"")||e===(t||"").toString()||("string"==typeof t?this.stringMatches(e,t):"number"==typeof t?this.numberMatches(e,t):"boolean"==typeof t&&this.boolMatches(e,t)))},e.stringMatches=function(e,t){return e=(e||"").toLowerCase(),(t=(t||"").toLowerCase()).indexOf(e)>=0},e.numberMatches=function(e,t){if(""===(e=e||""))return!0;var n=t||"";return e.toLowerCase().split(",").findIndex((function(e){return e===n.toString()}))>=0},e.boolMatches=function(e,t){if(""===(e=e||""))return!0;var n=(t||!1).toString().toLowerCase().trim();return e.toLowerCase().trim()===n},e}(),o=function e(){this.getTypeName=function(){return e.messageName}};o.messageName="rpc.subscription";var i=function(){var e=this;this.invoke=function(t){s.matches(e.eventFilter,t)&&e.eventHandler(t)},this.createSubscriptionMessage=function(){var t=new o;return t.Subscriptions=[{Enabled:!0,EventName:e.eventName,EventFilter:e.eventFilter,SubscriptionId:e.subscriptionId}],t},this.createUnsubscriptionMessage=function(){var t=e.createSubscriptionMessage();return delete t.Subscriptions[0].EventFilter,t.Subscriptions[0].Enabled=!1,t}},c=function(){var e=this;this.emitter=new t.EventEmitter,this.subscriptions={},this.add=function(t){return e.subscriptions[t.subscriptionId]=t,e.emitter.on(t.eventName,t.invoke,t),function(){delete e.subscriptions[t.subscriptionId],e.emitter.off(t.eventName,t.invoke,t)}},this.broadcast=function(t,n){e.emitter.emit(t,n)}},a=function(){},u=function(){this.getTypeName=function(){return"rpc.authenticate"},this.createResponse=function(){return new a},this.Parameters={}};u.userNameKey="UserName",u.passwordKey="Password";var f=function(){function e(e){this.parameters={},e&&(this.parameters[u.userNameKey]=e.userName,this.parameters[u.passwordKey]=e.password)}return e.prototype.authenticate=function(e){try{var t=new u;return t.Parameters=this.parameters,Promise.resolve(e.call(t)).then((function(e){return e.SessionId}))}catch(e){return Promise.reject(e)}},e}(),d=function(){function e(){}return e.prototype.getTypeName=function(){return"rpc.logout"},e}(),h=function(e,t){this.id=e,this.promise=t},l=function(e,t,n){this.jsonrpc="2.0",this.method=e,this.params=t,this.id=n},p=function(){function e(e,t){void 0===t&&(t={reconnect:!0,reconnectInterval:5e3,maxReconnects:10}),this.url=e,this.options=t,this.connected=!1,this.reconnects=0,this.pendingMessages={},this.traceMessage=function(e){},this.errorFilter=function(e){},this.lastMessageId=0,this.subscriptionManager=new c,this.credentials=t.credentials,this.call=this.call.bind(this),this.notify=this.notify.bind(this),this.subscribe=this.subscribe.bind(this),this.generateMessageId=this.generateMessageId.bind(this),this.nameOf=this.nameOf.bind(this)}var t=e.prototype;return t.disconnect=function(){try{var e=this,t=function(){if(e.webSocket&&e.connected)return Promise.resolve(e.notify(new d)).then((function(){e.webSocket.close(),e.connected=!1,delete e.webSocket,delete e.connectPromise}))}();return Promise.resolve(t&&t.then?t.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},t.rejectPendingMessages=function(e){var t="Connection was closed.";1e3!==e.code&&(t="Connection was aborted. Error code: "+e.code);var n=new Error(t);for(var r in Object.defineProperty(n,"code",{value:-32003}),this.pendingMessages)if(Object.prototype.hasOwnProperty.call(this.pendingMessages,r)){var s=this.pendingMessages[r];s&&(delete this.pendingMessages[r],this.errorFilter(n),s.reject(n))}},t.connect=function(e){var t=this;if(this.connectPromise)return this.connectPromise;var s=e||this.credentials||new f;return this.connectPromise=new Promise((function(e,o){t.webSocket?e(t.sessionId):(t.webSocket=new r(t.url),t.webSocket.onerror=function(e){t.connected=!1,delete t.webSocket,delete t.connectPromise;var n="Couldn't connect to "+t.url;e.message&&(n=n+": "+e.message);var r=new Error(n);t.errorFilter(r),o(r)},t.webSocket.onopen=function(){try{t.connected=!0;var r=n._catch((function(){return Promise.resolve(s.authenticate(t)).then((function(n){t.sessionId=n,t.reconnects=0,e(t.sessionId)}))}),(function(e){t.connected=!1,t.errorFilter(e),o(e),delete t.webSocket,delete t.connectPromise}));return Promise.resolve(r&&r.then?r.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},t.webSocket.onclose=function(n){t.connected=!1,t.rejectPendingMessages(n),delete t.webSocket,delete t.connectPromise,1e3!==n.code?(t.reconnects++,t.options.reconnect&&(t.options.maxReconnects<t.reconnects||0===t.options.maxReconnects)&&setTimeout((function(){return t.connect()}),t.options.reconnectInterval),e(t.sessionId)):e(t.sessionId)},t.webSocket.onmessage=function(e){t.traceMessage({isOutcoming:!1,data:e.data.toString()});var n,r="string"==typeof e.data?e.data:"";e.data instanceof ArrayBuffer&&(r=Buffer.from(e.data).toString());try{n=JSON.parse(r)}catch(e){return t.errorFilter(e),void t.errorFilter(new Error("Error parsing JSON: "+r))}if(n.id){var s=t.pendingMessages[n.id];if(s){if(delete t.pendingMessages[n.id],n.error)return t.errorFilter(n.error),void s.reject(n.error);s.resolve(n.result)}}else t.subscriptionManager.broadcast(n.method,n.params)})}))},t.call=function(e){try{var t=function(){return Promise.resolve(n.callCore(e))},n=this,r=function(){if(!n.connected)return Promise.resolve(n.connect()).then((function(){}))}();return Promise.resolve(r&&r.then?r.then(t):t())}catch(e){return Promise.reject(e)}},t.callCore=function(e){var t=this,n=this.nameOf(e),r=this.generateMessageId(),s=new l(n,e,r),o=JSON.stringify(s),i=new h(r);return this.pendingMessages[r]=i,i.promise=new Promise((function(e,n){if(i.resolve=e,i.reject=n,void 0===t.webSocket||!t.connected){delete t.pendingMessages[r];var s=new Error("WebSocket not connected");return t.errorFilter(s),void n(s)}t.traceMessage({isOutcoming:!0,data:o}),t.webSocket.send(o)}))},t.notify=function(e){try{var t=function(){var t=n.nameOf(e),r=new l(t,e),s=JSON.stringify(r);if(void 0===n.webSocket||!n.connected){var o=new Error("WebSocket not connected");throw n.errorFilter(o),o}n.traceMessage({isOutcoming:!0,data:s}),n.webSocket.send(s)},n=this,r=function(){if(!n.connected)return Promise.resolve(n.connect()).then((function(){}))}();return Promise.resolve(r&&r.then?r.then(t):t())}catch(e){return Promise.reject(e)}},t.generateMessageId=function(){return++this.lastMessageId+""},t.nameOf=function(e){if(!e)return"null";if("function"==typeof e.getTypeName)return e.getTypeName();var t=e&&e.constructor;if(null===t){var n=new Error(e+" doesn't have constructor");throw this.errorFilter(n),n}if(t.name)return t.name;var r=t.toString();return r.substring(9,r.indexOf("("))},t.subscribe=function(e){try{var t=function(){var t=new i;t.subscriptionId=n.generateMessageId(),t.eventName=e.eventName,t.eventHandler=e.eventHandler,t.eventFilter=e.eventFilter;var r=t.createSubscriptionMessage();return Promise.resolve(n.call(r)).then((function(){var e=n.subscriptionManager.add(t),r=t.createUnsubscriptionMessage();return function(){try{return e(),Promise.resolve(n.call(r)).then((function(){}))}catch(e){return Promise.reject(e)}}}))},n=this,r=function(){if(!n.connected)return Promise.resolve(n.connect()).then((function(){}))}();return Promise.resolve(r&&r.then?r.then(t):t())}catch(e){return Promise.reject(e)}},e}(),m=function(){},v=function(){function e(){}var t=e.prototype;return t.getTypeName=function(){return"rpc.version"},t.createResponse=function(){return new m},e}();exports.AuthRequest=u,exports.AuthResponse=a,exports.ClientSubscription=i,exports.ClientSubscriptionManager=c,exports.CredentialsBase=f,exports.EventFilter=s,exports.JsonClient=p,exports.LogoutMessage=d,exports.SubscriptionMessage=o,exports.VersionRequest=v,exports.VersionResponse=m;
//# sourceMappingURL=json-services-client.cjs.production.min.js.map
